<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>Alls - Marché Libre</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        /* ... (le CSS reste inchangé, voir les versions précédentes) ... */
        .country-flag {
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
            width: 32px;
            height: 22px;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.12);
            background-size: cover;
            background-position: 50% 50%;
            border: 1px solid var(--border);
        }
        .form-group-country {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            position: relative;
        }
        .form-country-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        /* Nouveau bouton "À propos" */
        .btn-about {
            background: var(--accent);
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.2rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            margin-left: 0.5rem;
        }
        .btn-about:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
        }
        /* Modal styles */
        .modal-apropos {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.3);
            align-items: center;
            justify-content: center;
        }
        .modal-apropos.active {
            display: flex;
        }
        .modal-content-apropos {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 2rem 2.5rem;
            max-width: 400px;
            width: 90vw;
            position: relative;
            text-align: center;
            animation: fadeInUp 0.4s;
        }
        .modal-content-apropos h3 {
            margin-bottom: 1rem;
            color: var(--primary);
            font-size: 1.25rem;
        }
        .modal-content-apropos p {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        .modal-apropos .close-modal {
            position: absolute;
            top: 1rem; right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }
    </style>
    <style>
        :root {
            --primary: #3B82F6;
            --primary-dark: #2563EB;
            --secondary: #10B981;
            --secondary-dark: #059669;
            --accent: #F59E0B;
            --accent-dark: #D97706;
            --background: #F8FAFC;
            --surface: #FFFFFF;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --border: #E2E8F0;
            --border-light: #F1F5F9;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        /* ... (reste du CSS inchangé) ... */
    </style>
     <style>
        /* ... (le CSS reste inchangé, voir les versions précédentes) ... */
        .country-flag {
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
            width: 32px;
            height: 22px;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.12);
            background-size: cover;
            background-position: 50% 50%;
            border: 1px solid var(--border);
        }
        .form-group-country {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            position: relative;
        }
        .form-country-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
    <style>
        :root {
            --primary: #3B82F6;
            --primary-dark: #2563EB;
            --secondary: #10B981;
            --secondary-dark: #059669;
            --accent: #F59E0B;
            --accent-dark: #D97706;
            --background: #F8FAFC;
            --surface: #FFFFFF;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --border: #E2E8F0;
            --border-light: #F1F5F9;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        /* Background Image - Plus visible */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?ixlib=rb-4.0.3&auto=format&fit=crop&w=2340&q=80');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            z-index: -2;
        }

        /* Overlay réduit pour laisser voir l'arrière-plan */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(248, 250, 252, 0.3);
            backdrop-filter: blur(1px);
            z-index: -1;
        }

        /* Header avec transparence */
        .header {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(16, 185, 129, 0.95) 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.75rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .logo i {
            font-size: 2rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            text-align: center;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-success:hover {
            background: var(--secondary-dark);
            transform: translateY(-1px);
        }

        .btn-warning {
            background: var(--accent);
            color: white;
        }

        .btn-warning:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--text-primary);
        }

        /* Main Content */
        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Form Section avec transparence */
        .form-section {
            margin-bottom: 3rem;
        }

        .form-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .form-header {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(16, 185, 129, 0.95) 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .form-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .form-content {
            padding: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-label .required {
            color: #EF4444;
        }

        .form-input {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(255, 255, 255, 0.95);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }

        /* Articles Section */
        .articles-section h2 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .article-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.4);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.95);
        }

        .article-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--border-light);
        }

        .article-content {
            padding: 1.5rem;
        }

        .article-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .article-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 1rem;
        }

        .article-id {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: rgba(241, 245, 249, 0.8);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .article-contact {
            margin-bottom: 1rem;
        }

        .contact-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .contact-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .contact-whatsapp {
            background: #25D366;
            color: white;
        }

        .contact-whatsapp:hover {
            background: #128C7E;
        }

        .contact-email {
            background: var(--primary);
            color: white;
        }

        .contact-email:hover {
            background: var(--primary-dark);
        }

        .article-actions {
            display: flex;
            gap: 0.75rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
        }

        .spinner {
            width: 2rem;
            height: 2rem;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(226, 232, 240, 0.5);
            margin-top: 3rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .main {
                padding: 1rem;
            }

            .form-content {
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .articles-grid {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }

            .article-actions {
                flex-direction: column;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeInUp 0.5s ease-out;
        }

        /* Hidden state */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-store"></i>
                <span>BIENVENUE A VOUS SUR ALLs '' Un marché pour tous''</span>
            </div>
            <div style="display: flex; align-items: center;">
                <button class="btn btn-primary" id="toggle-form-btn">
                    <i class="fas fa-plus"></i>
                    Publier un article
                </button>
                <a href="apropos.html" class="btn-about" style="text-decoration: none;">
    <i class="fas fa-info-circle"></i>
    À propos
</a>
                </button>
            </div>
        </div>
    </header>

    <!-- Modal À propos -->
    <div class="modal-apropos" id="modal-apropos">
        <div class="modal-content-apropos">
            <button class="close-modal" id="close-apropos" aria-label="Fermer">&times;</button>
            <h3>À propos de Alls</h3>
            <p>
                Alls est une plateforme de marché libre permettant à tous de publier et consulter des articles en toute simplicité.<br>
                Achetez, vendez et échangez facilement, partout et à tout moment !
            </p>
        </div>
    </div>

    <main class="main">
        <!-- Form Section -->
        <div id="form-section" class="form-section hidden">
            <div class="form-card fade-in">
                <div class="form-header">
                    <i class="fas fa-plus-circle"></i>
                    <h2>Publier un nouvel article</h2>
                </div>
                <div class="form-content">
                    <form id="article-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-tag"></i>
                                    Nom de l'article <span class="required">*</span>
                                </label>
                                <input type="text" id="nom" class="form-input" placeholder="Ex: iPhone 14 Pro Max" required />
                            </div>
                            <div class="form-group-country">
                                <label class="form-label">
                                    <i class="fas fa-globe"></i>
                                    Pays <span class="required">*</span>
                                </label>
                                <div class="form-country-row">
                                    <select id="pays" class="form-input" required>
                                        <option value="" data-flag="">-- Choisissez un pays --</option>
                                        <option value="CI" data-flag="https://flagcdn.com/ci.svg" data-indicatif="+225">Côte d'Ivoire</option>
                                        <option value="SN" data-flag="https://flagcdn.com/sn.svg" data-indicatif="+221">Sénégal</option>
                                        <option value="BJ" data-flag="https://flagcdn.com/bj.svg" data-indicatif="+229">Bénin</option>
                                        <option value="TG" data-flag="https://flagcdn.com/tg.svg" data-indicatif="+228">Togo</option>
                                        <option value="CI" data-flag="https://flagcdn.com/ci.svg" data-indicatif="+225">Côte d'Ivoire</option>
                                        <option value="CM" data-flag="https://flagcdn.com/cm.svg" data-indicatif="+237">Cameroun</option>
                                        <option value="FR" data-flag="https://flagcdn.com/fr.svg" data-indicatif="+33">France</option>
                                        <option value="BF" data-flag="https://flagcdn.com/bf.svg" data-indicatif="+226">Burkina Faso</option>
                                    </select>
                                    <span id="flag-container"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-money-bill-wave"></i>
                                    Prix (FCFA) <span class="required">*</span>
                                </label>
                                <input type="number" id="prix" class="form-input" placeholder="Ex: 450000" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-phone"></i>
                                    Contact WhatsApp ou Email <span class="required">*</span>
                                </label>
                                <input type="text" id="contact" class="form-input" placeholder="Ex: +225XXXXXXXX ou email@example.com" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-camera"></i>
                                    Photo de l'article <span class="required">*</span>
                                </label>
                                <input type="file" id="photo" class="form-input" accept="image/*" required />
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">Maximum 200Ko (sera automatiquement ajustée si besoin)</small>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancel-btn">
                                <i class="fas fa-times"></i>
                                Annuler
                            </button>
                            <button type="submit" class="btn btn-success" id="submit-btn">
                                <i class="fas fa-check"></i>
                                Publier l'article
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Articles Section -->
        <div class="articles-section">
            <h2>
                <i class="fas fa-shopping-bag"></i>
                Articles récents
            </h2>
            <div id="articles" class="articles-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    Chargement des articles...
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Alls - Marché ouvert à tous. Plateforme de commerce en ligne.</p>
    </footer>
<script>
    // Configuration Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAj_JRgQupGeETFrVz1IbcEC1HZSRKur5E",
    authDomain: "marcher-5a39b.firebaseapp.com",
    databaseURL: "https://marcher-5a39b-default-rtdb.firebaseio.com",
    projectId: "marcher-5a39b",
    storageBucket: "marcher-5a39b.appspot.com",
    messagingSenderId: "133904247907",
    appId: "1:133904247907:web:da360e798307fb982e1c56",
    measurementId: "G-BH7H6FQ6VX"
};

// Initialisation Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Variables globales
const elements = {
    formSection: document.getElementById("form-section"),
    toggleBtn: document.getElementById("toggle-form-btn"),
    articlesContainer: document.getElementById("articles"),
    articleForm: null
};

let state = {
    formVisible: false,
    articles: {},
    loading: true
};

function toggleForm(autoShow = false) {
    state.formVisible = autoShow ? true : !state.formVisible;
    if (state.formVisible) {
        elements.formSection.classList.remove('hidden');
        elements.toggleBtn.innerHTML = '<i class="fas fa-times"></i> Fermer le formulaire';
        initFormHandlers();

        // Scroll automatique vers le formulaire
        setTimeout(() => {
            elements.formSection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }, 100);
    } else {
        elements.formSection.classList.add('hidden');
        elements.toggleBtn.innerHTML = '<i class="fas fa-plus"></i> Publier un article';
    }
}

function initFormHandlers() {
    const form = document.getElementById('article-form');
    const cancelBtn = document.getElementById('cancel-btn');
    const paysSelect = document.getElementById('pays');
    const flagContainer = document.getElementById('flag-container');

    if (form && !form.dataset.initialized) {
        form.addEventListener('submit', handleFormSubmit);
        form.dataset.initialized = 'true';
    }

    if (cancelBtn) {
        cancelBtn.onclick = () => toggleForm(false);
    }

    if (paysSelect && flagContainer) {
        paysSelect.addEventListener('change', function () {
            const selectedOption = paysSelect.options[paysSelect.selectedIndex];
            const flagUrl = selectedOption.getAttribute('data-flag');
            flagContainer.innerHTML = flagUrl ? `<span class="country-flag" style="background-image:url('${flagUrl}')"></span>` : '';

            // --- Début auto-remplissage de l'indicatif ---
            const indicatif = selectedOption.getAttribute('data-indicatif');
            const contactInput = document.getElementById('contact');
            // On ne remplit que si le champ est vide ou ne commence pas déjà par '+'
            if (
                indicatif &&
                contactInput &&
                (
                    contactInput.value.trim() === '' ||
                    contactInput.value.trim().charAt(0) !== '+'
                )
            ) {
                contactInput.value = indicatif;
                contactInput.focus();
                // Place le curseur à la fin de l'indicatif
                contactInput.setSelectionRange(contactInput.value.length, contactInput.value.length);
            }
            // --- Fin auto-remplissage de l'indicatif ---
        });
    }
}

async function handleFormSubmit(e) {
    e.preventDefault();

    const formData = {
        nom: document.getElementById("nom").value.trim(),
        pays: document.getElementById("pays").value,
        prix: document.getElementById("prix").value.trim(),
        contact: document.getElementById("contact").value.trim(),
        photo: document.getElementById("photo").files[0]
    };

    const submitBtn = document.getElementById("submit-btn");

    // Validation
    if (!formData.nom || !formData.prix || !formData.contact || !formData.photo || !formData.pays) {
        alert("Tous les champs sont obligatoires !");
        return;
    }

    // Redimensionner et compresser l'image si > 200Ko
    let photoDataUrl;
    try {
        photoDataUrl = await compressImageToUnder200KB(formData.photo);
    } catch (error) {
        alert("Impossible de traiter l'image. Essayez avec une autre photo.");
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Publier l\'article';
        return;
    }

    // État de chargement
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publication...';

    try {
        const paysSelect = document.getElementById("pays");
        const selectedOption = paysSelect.options[paysSelect.selectedIndex];
        const flagUrl = selectedOption.getAttribute('data-flag') || '';

        const newArticleRef = db.ref("articles").push();
        const articleData = {
            id: newArticleRef.key,
            nom: formData.nom,
            pays: formData.pays,
            flagUrl: flagUrl,
            prix: formData.prix,
            contact: formData.contact,
            photoDataUrl: photoDataUrl,
            createdAt: Date.now()
        };

        await newArticleRef.set(articleData);

        document.getElementById('article-form').reset();
        document.getElementById('flag-container').innerHTML = '';
        toggleForm(false);

        showNotification('Article publié avec succès !', 'success');

    } catch (error) {
        console.error('Erreur lors de la publication:', error);
        alert("Erreur lors de la publication. Veuillez réessayer.");
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Publier l\'article';
    }
}

// Fonction pour compresser/redimensionner l'image en moins de 200ko
function compressImageToUnder200KB(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function (event) {
            const img = new Image();
            img.onload = function () {
                let canvas = document.createElement('canvas');
                let ctx = canvas.getContext('2d');
                let width = img.width;
                let height = img.height;
                let maxAttempts = 10;
                let attempt = 0;
                let quality = 0.92; // start high, decrease if needed

                function tryCompress() {
                    canvas.width = width;
                    canvas.height = height;
                    ctx.clearRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);

                    let dataUrl = canvas.toDataURL('image/jpeg', quality);
                    let size = Math.ceil((dataUrl.length - 'data:image/jpeg;base64,'.length) * 3 / 4);

                    // Si <= 200ko, nickel, sinon on réduit qualité et/ou taille
                    if (size <= 200 * 1024 || attempt >= maxAttempts) {
                        resolve(dataUrl);
                    } else {
                        // Réduire la qualité ou la taille
                        if (quality > 0.5) {
                            quality -= 0.08;
                        } else {
                            width *= 0.85;
                            height *= 0.85;
                        }
                        attempt++;
                        setTimeout(tryCompress, 0);
                    }
                }
                tryCompress();
            };
            img.onerror = reject;
            img.src = event.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function getContactLink(article) {
    const isWhatsApp = article.contact && (article.contact.includes("+") || /^\d{8,15}$/.test(article.contact));
    const message = encodeURIComponent(`Bonjour, je suis intéressé par l'article "${article.nom}" (${article.prix} FCFA), ID: ${article.id} (vu sur Alls).`);

    if (isWhatsApp) {
        const tel = article.contact.replace(/[^0-9+]/g, "");
        return `<a href="https://wa.me/${tel}?text=${message}" target="_blank" rel="noopener noreferrer" class="contact-link contact-whatsapp">
            <i class="fab fa-whatsapp"></i>
            ${article.contact}
        </a>`;
    } else {
        const subject = encodeURIComponent(`Commande de l'article Alls N°${article.id}`);
        const emailBody = encodeURIComponent(`Bonjour, je souhaite commander l'article "${article.nom}" (${article.prix} FCFA), ID: ${article.id} (vu sur Alls).`);
        return `<a href="mailto:${article.contact}?subject=${subject}&body=${emailBody}" class="contact-link contact-email">
            <i class="fas fa-envelope"></i>
            ${article.contact}
        </a>`;
    }
}

function renderArticle(article) {
    return `
        <div class="article-card fade-in" id="article-${article.id}">
            <img src="${article.photoDataUrl}" alt="${article.nom}" class="article-image clickable-article-image" data-img="${article.photoDataUrl}" loading="lazy" />
            <div class="article-content">
                <h3 class="article-title">${article.nom}</h3>
                <div class="article-price">
                    ${parseInt(article.prix).toLocaleString()} FCFA
                    ${article.flagUrl ? `<span class="country-flag" style="background-image:url('${article.flagUrl}')"></span>` : ''}
                </div>
                <div class="article-id">ID: ${article.id} ${article.pays ? '- ' + article.pays : ''}</div>
                <div class="article-contact">
                    <div class="contact-label">Contact :</div>
                    ${getContactLink(article)}
                </div>
                <div class="article-actions">
                    <button class="btn btn-warning" onclick="commanderArticle('${article.id}')" style="flex: 1;">
                        <i class="fas fa-shopping-cart"></i>
                        Commander
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Modal pour agrandir la photo
function createImageModal() {
    if (document.getElementById('image-modal')) return;
    const modal = document.createElement('div');
    modal.id = 'image-modal';
    modal.style.display = 'none';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100vw';
    modal.style.height = '100vh';
    modal.style.background = 'rgba(0,0,0,0.8)';
    modal.style.zIndex = '10000';
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    modal.style.cursor = 'zoom-out';

    modal.innerHTML = `
        <img id="modal-image" src="" alt="Agrandissement" style="max-width:90vw;max-height:90vh;box-shadow:0 4px 32px #000;" />
    `;

    modal.onclick = function () {
        modal.style.display = 'none';
        document.getElementById('modal-image').src = '';
        document.body.style.overflow = '';
    };

    document.body.appendChild(modal);
}

function setupBigImageOnClick() {
    createImageModal();
    document.querySelectorAll('.clickable-article-image').forEach(img => {
        img.onclick = function (e) {
            e.stopPropagation();
            const src = this.getAttribute('data-img');
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image');
            if (src && modal && modalImg) {
                modalImg.src = src;
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }
    });
}

function commanderArticle(articleId) {
    const article = state.articles[articleId];
    if (!article) return;

    const subject = encodeURIComponent(`Commande de l'article Alls N°${article.id}`);
    const message = encodeURIComponent(`Bonjour, je souhaite commander l'article "${article.nom}" (${article.prix} FCFA), ID: ${article.id} (vu sur Alls).`);

    const isWhatsApp = article.contact && (article.contact.includes("+") || /^\d{8,15}$/.test(article.contact));

    if (isWhatsApp) {
        const tel = article.contact.replace(/[^0-9+]/g, "");
        window.open(`https://wa.me/${tel}?text=${message}`, "_blank");
    } else {
        window.location.href = `mailto:${article.contact}?subject=${subject}&body=${message}`;
    }
}

function renderArticles() {
    const articlesArray = Object.values(state.articles).sort((a, b) => b.createdAt - a.createdAt);

    if (articlesArray.length === 0) {
        elements.articlesContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-shopping-bag"></i>
                <h3>Aucun article pour le moment</h3>
                <p>Soyez le premier à publier un article !</p>
            </div>
        `;
    } else {
        elements.articlesContainer.innerHTML = articlesArray.map(renderArticle).join('');
    }
    setupBigImageOnClick();
}

function showNotification(message, type = 'info') {
    // Simple notification - peut être améliorée avec une library
    console.log(`${type}: ${message}`);
}

function initializeApp() {
    // Affiche le formulaire automatiquement quand on clique sur Publier un article
    elements.toggleBtn.addEventListener('click', () => toggleForm(true));
    loadArticles();
}

function loadArticles() {
    db.ref('articles').once('value')
        .then(snapshot => {
            state.articles = {};
            snapshot.forEach(childSnap => {
                const article = childSnap.val();
                article.id = childSnap.key;
                state.articles[article.id] = article;
            });
            state.loading = false;
            renderArticles();
        })
        .catch(error => {
            console.error('Erreur lors du chargement:', error);
            elements.articlesContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Erreur de chargement</h3>
                    <p>Impossible de charger les articles. Veuillez actualiser la page.</p>
                </div>
            `;
        });

    db.ref('articles').on('child_added', snapshot => {
        const article = snapshot.val();
        article.id = snapshot.key;
        if (!state.loading && !state.articles[article.id]) {
            state.articles[article.id] = article;
            renderArticles();
        }
    });

    db.ref('articles').on('child_removed', snapshot => {
        const articleId = snapshot.key;
        if (state.articles[articleId]) {
            delete state.articles[articleId];
            renderArticles();
        }
    });
}

window.commanderArticle = commanderArticle;
document.addEventListener('DOMContentLoaded', initializeApp);
</script>